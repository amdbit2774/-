#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
SCRIPT_PATH="$SCRIPT_DIR/telegram_poster.py"
LOG_PATH="$SCRIPT_DIR/bot.log"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "‚ùå –°–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: $SCRIPT_PATH"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ Python
PYTHON_PATH=$(which python3)
if [ -z "$PYTHON_PATH" ]; then
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ PATH"
    exit 1
fi

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞..."
echo "   –°–∫—Ä–∏–ø—Ç: $SCRIPT_PATH"
echo "   Python: $PYTHON_PATH"
echo "   –õ–æ–≥–∏: $LOG_PATH"

# –°–æ–∑–¥–∞–µ–º cron job
CRON_JOB="0 */2 * * * cd $SCRIPT_DIR && $PYTHON_PATH $SCRIPT_PATH >> $LOG_PATH 2>&1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–¥–∞—á–∞
if crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"; then
    echo "‚ö†Ô∏è  –ó–∞–¥–∞—á–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ crontab"
    echo "   –ü–æ–∫–∞–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞—á–∏: crontab -l"
    echo "   –î–ª—è –∑–∞–º–µ–Ω—ã –∑–∞–¥–∞—á–∏ —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é: crontab -e"
    exit 1
fi

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
echo "üìù –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é cron –∑–∞–¥–∞—á—É..."
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -

if [ $? -eq 0 ]; then
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!"
    echo ""
    echo "üìã –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏:"
    echo "   –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ (–≤ 00:00, 02:00, 04:00, 06:00, 08:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00)"
    echo "   –ö–æ–º–∞–Ω–¥–∞: $CRON_JOB"
    echo ""
    echo "üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–¥–∞—á: crontab -l"
    echo "   –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á: crontab -e"
    echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f $LOG_PATH"
    echo "   –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á: crontab -r"
    echo ""
    echo "‚ö° –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è, –∫—Ä–∞—Ç–Ω–æ–µ 2 —á–∞—Å–∞–º"
    echo "   –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: $PYTHON_PATH $SCRIPT_PATH"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ cron –∑–∞–¥–∞—á–∏"
    exit 1
fi 